name: ğŸš€ Release

on:
  push:
    tags:
      - "v*"

jobs:
  create-release:
    name: ğŸ“¦ Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“‹ Generate changelog
        id: changelog
        run: |
          # Get the latest tag before this one
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "^${{ github.ref_name }}$" | head -n 1)

          if [ -z "$PREVIOUS_TAG" ]; then
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi

          # Generate changelog
          echo "## ğŸ‰ What's Changed" > CHANGELOG.md
          echo "" >> CHANGELOG.md

          # Get commits since last tag
          git log ${PREVIOUS_TAG}..${{ github.ref_name }} --pretty=format:"- %s (%h)" --no-merges >> CHANGELOG.md

          # Add Docker image info
          echo "" >> CHANGELOG.md
          echo "## ğŸ³ Docker Image" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "\`\`\`bash" >> CHANGELOG.md
          echo "docker pull ghcr.io/${{ github.repository_owner }}/spotify-tools:${{ github.ref_name }}" >> CHANGELOG.md
          echo "\`\`\`" >> CHANGELOG.md

      - name: ğŸ·ï¸ Create Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: CHANGELOG.md
          generate_release_notes: true
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-deployment:
    name: ğŸ“¢ Notify Deployment
    runs-on: ubuntu-latest
    needs: create-release
    if: always()

    steps:
      - name: ğŸ‰ Deployment notification
        run: |
          echo "ğŸš€ Release ${{ github.ref_name }} has been created!"
          echo "ğŸ³ Docker image: ghcr.io/${{ github.repository_owner }}/spotify-tools:${{ github.ref_name }}"
          echo "ğŸ“¦ Release page: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
