name: üß™ Test Dart Sass CLI

on:
  push:
    branches: [debug-pipeline-scss]
  workflow_dispatch:

jobs:
  test-dart-sass:
    name: üîß Test Dart Sass CLI Integration
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üß™ Test Dart Sass CLI Integration
        run: |
          echo "=== TESTING DART SASS CLI INTEGRATION ==="
          cat > flask/Dockerfile.dart-sass-test << 'EOF'
          FROM python:3.12-slim
          WORKDIR /app
          
          # Install Dart Sass CLI
          RUN apt-get update && apt-get install -y \
              curl \
              && curl -fsSL https://github.com/sass/dart-sass/releases/download/1.89.2/dart-sass-1.89.2-linux-x64.tar.gz \
              | tar -xz -C /opt \
              && ln -s /opt/dart-sass/sass /usr/local/bin/sass \
              && apt-get remove -y curl \
              && apt-get autoremove -y \
              && rm -rf /var/lib/apt/lists/*
          
          COPY requirements.txt .
          COPY requirements-prod.txt .
          RUN pip install --no-cache-dir -r requirements-prod.txt
          
          COPY . .
          
          # Test Dart Sass CLI and Flask-Assets integration
          CMD bash -c "
          echo '=== DART SASS VERSION ===' && \
          sass --version && \
          echo && \
          echo '=== TESTING SCSS COMPILATION ===' && \
          echo '\$primary-color: #1db954; .test { color: \$primary-color; &:hover { opacity: 0.8; } }' > test.scss && \
          sass --style=compressed --no-source-map test.scss test.css && \
          echo 'Generated CSS:' && \
          cat test.css && \
          echo && \
          echo '=== TESTING FLASK-ASSETS INTEGRATION ===' && \
          python -c \"
          import sys
          print(f'Python: {sys.version}')
          try:
              from app import app
              with app.app_context():
                  from flask_assets import Environment
                  assets = Environment(app)
                  bundle = assets['scss_all']
                  urls = bundle.urls()
                  print(f'‚úÖ Flask-Assets bundle URLs: {urls}')
                  print('‚úÖ ALL TESTS PASSED! Dart Sass CLI works perfectly!')
          except Exception as e:
              print(f'‚ùå Flask-Assets test failed: {e}')
              import traceback
              traceback.print_exc()
              exit(1)
          \"
          "
          EOF
          
          docker buildx build \
            --platform linux/amd64 \
            --file ./flask/Dockerfile.dart-sass-test \
            ./flask \
            --tag test-dart-sass \
            --load
          
          docker run --rm test-dart-sass
